name: Create Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v0.2.1 ç­‰è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: Extract version from tag
        id: get_version
        run: |
          # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå»é™¤ 'v' å‰ç¼€ï¼‰
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?(\+[a-zA-Z0-9\.]+)?$ ]]; then
            echo "é”™è¯¯ï¼šç‰ˆæœ¬å· '$VERSION' ä¸ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ¼å¼ (x.y.z)"
            exit 1
          fi

      - name: Verify pyproject.toml version
        run: |
          # ä» pyproject.toml è¯»å–ç‰ˆæœ¬å·
          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | cut -d'"' -f2)
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          
          echo "pyproject.toml ç‰ˆæœ¬: $PYPROJECT_VERSION"
          echo "æ ‡ç­¾ç‰ˆæœ¬: $TAG_VERSION"
          
          # å»ºè®®æ£€æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§ï¼ˆå¯é€‰ï¼‰
          if [ "$PYPROJECT_VERSION" != "$TAG_VERSION" ]; then
            echo "âš ï¸  è­¦å‘Šï¼špyproject.toml ç‰ˆæœ¬ ($PYPROJECT_VERSION) ä¸æ ‡ç­¾ç‰ˆæœ¬ ($TAG_VERSION) ä¸ä¸€è‡´"
            echo "å»ºè®®åœ¨æ‰“æ ‡ç­¾å‰æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆç”¨äºå¯èƒ½çš„æµ‹è¯•æˆ–æ„å»ºï¼‰
          pip install -e .

      - name: Run tests (optional)
        run: |
          echo "è¿è¡ŒåŸºæœ¬ä»£ç æ£€æŸ¥..."
          # æ£€æŸ¥æ ¹ç›®å½•ä¸­çš„Pythonæ–‡ä»¶
          python -m py_compile *.py
          echo "ä»£ç æ£€æŸ¥å®Œæˆ"

      - name: Generate changelog
        id: changelog
        run: |
          # ç”Ÿæˆç®€å•çš„å˜æ›´æ—¥å¿—
          echo "## ç‰ˆæœ¬ ${{ steps.get_version.outputs.version }} å˜æ›´æ—¥å¿—" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### å‘å¸ƒæ—¥æœŸ: $(date +'%Y-%m-%d')" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
          if git describe --tags --abbrev=0 HEAD~1 2>/dev/null; then
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1)
            echo "### è‡ª $PREV_TAG ä»¥æ¥çš„å˜æ›´ï¼š" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            echo "### åˆå§‹ç‰ˆæœ¬" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" --reverse >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "*è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions*" >> CHANGELOG.md

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          name: "Hyperate Overlay v${{ steps.get_version.outputs.version }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          generate_release_notes: true  # åŒæ—¶ä½¿ç”¨GitHubçš„è‡ªåŠ¨ç”Ÿæˆå‘å¸ƒè¯´æ˜
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload source code as asset
        run: |
          # åˆ›å»ºæºä»£ç å‹ç¼©åŒ…
          VERSION="${{ steps.get_version.outputs.version }}"
          ARCHIVE_NAME="hyperate-overlay-v$VERSION-source.zip"
          
          # æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          zip -r "$ARCHIVE_NAME" . \
            -x "*.git*" \
            -x ".github/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".env" \
            -x ".venv/*" \
            -x "*.egg-info/*"
          
          echo "æºä»£ç åŒ…å·²åˆ›å»º: $ARCHIVE_NAME"
          
          # ä¸Šä¼ åˆ°Release
          gh release upload "${{ steps.create_release.outputs.tag_name }}" "$ARCHIVE_NAME" \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show release info
        run: |
          echo "ğŸ‰ å‘å¸ƒåˆ›å»ºæˆåŠŸï¼"
          echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
          echo "Release URL: ${{ steps.create_release.outputs.url }}"
          echo ""
          echo "ä¸‹æ¬¡å‘å¸ƒæ—¶ï¼Œè¯·è®°å¾—ï¼š"
          echo "1. æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·"
          echo "2. åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: git tag vx.y.z"
          echo "3. æ¨é€æ ‡ç­¾åˆ°GitHub: git push origin vx.y.z"
